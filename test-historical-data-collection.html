<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Historical Data Collection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            width: 100%;
        }
        button:hover {
            background: #0056b3;
        }
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .fix-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .fix-list ul {
            margin: 0;
            padding-left: 20px;
        }
        .fix-list li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Historical Data Collection</h1>
        
        <div class="status success">
            <strong>‚úÖ Historical Data Collection Fix Applied:</strong><br>
            The data collection API now saves data to both the dashboard (monitoringData) and historical tables (historical_news_data, historical_social_data).
        </div>
        
        <div class="test-section">
            <h3>üéØ The Problem:</h3>
            <p>Data was only being saved to <code>users.monitoringData</code> (for dashboard) but not to the historical tables that the Historical Data page uses.</p>
            <div class="fix-list">
                <ul>
                    <li><strong>Dashboard Data:</strong> Stored in <code>users.monitoringData</code> ‚úÖ</li>
                    <li><strong>Historical Data:</strong> Should be stored in <code>historical_news_data</code> and <code>historical_social_data</code> ‚ùå</li>
                    <li><strong>Result:</strong> Dashboard shows data, but Historical Data page shows "No data found"</li>
                </ul>
            </div>
        </div>
        
        <div class="test-section">
            <h3>‚úÖ The Fix Applied:</h3>
            <div class="fix-list">
                <ul>
                    <li><strong>Added Historical Table Imports:</strong> <code>historicalNewsData</code>, <code>historicalSocialData</code>, <code>dataCollectionJobs</code></li>
                    <li><strong>Create Collection Job:</strong> Records each data collection session</li>
                    <li><strong>Save News Data:</strong> Each article saved to <code>historical_news_data</code></li>
                    <li><strong>Save Social Data:</strong> Each post saved to <code>historical_social_data</code></li>
                    <li><strong>Dual Storage:</strong> Data saved to both dashboard and historical tables</li>
                </ul>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üß™ Test the Fix:</h3>
            <p>Trigger data collection and verify it appears in the Historical Data page.</p>
            <div class="button-group">
                <button onclick="createTestUser()">Create Test User</button>
                <button onclick="triggerDataCollection()">Trigger Data Collection</button>
                <button onclick="testHistoricalDataPage()">Test Historical Data Page</button>
                <button onclick="checkDataStorage()">Check Data Storage</button>
            </div>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        
        function createTestUser() {
            try {
                const testUser = {
                    id: 9,
                    name: "Test User",
                    email: "test@example.com",
                    plan: "pro",
                    status: "approved",
                    keywords: ["bmw", "artificial intelligence", "climate change"]
                };
                
                localStorage.setItem('user', JSON.stringify(testUser));
                
                log(`‚úÖ Test user created successfully!

üë§ User Details:
- ID: ${testUser.id}
- Name: ${testUser.name}
- Email: ${testUser.email}
- Plan: ${testUser.plan}
- Status: ${testUser.status}
- Keywords: ${testUser.keywords.join(', ')}

üéØ This user will be used to trigger data collection.`, 'success');
                
            } catch (error) {
                log(`‚ùå Error creating test user: ${error.message}`, 'error');
            }
        }
        
        async function triggerDataCollection() {
            try {
                const userData = localStorage.getItem('user');
                if (!userData) {
                    log('‚ùå Please create test user first!', 'error');
                    return;
                }
                
                const user = JSON.parse(userData);
                const token = btoa(JSON.stringify({ userId: user.id }));
                
                log('üöÄ Triggering data collection...\n', 'info');
                
                const response = await fetch('/api/data/collect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Data Collection Successful!

üìä Collection Results:
- Status: ${response.status}
- Message: ${result.message}
- Collection Job ID: ${result.collectionJobId}
- Keywords Processed: ${result.data?.length || 0}

üìã Data Storage:
‚úÖ Dashboard Data: Saved to users.monitoringData
‚úÖ Historical News: Saved to historical_news_data table
‚úÖ Historical Social: Saved to historical_social_data table
‚úÖ Collection Job: Recorded in data_collection_jobs table

üéØ The Historical Data page should now show data!
Try opening the Historical Data page to verify.`, 'success');
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Data Collection Failed!

Status: ${response.status}
Error: ${errorData.error}

üîç This might indicate:
- Server is not running
- No keywords found for user
- API endpoint issues

üí° Make sure the development server is running with: npm run dev`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error triggering data collection: ${error.message}

üîç This might indicate:
- Server is not running
- Network connectivity issues
- CORS issues

üí° Make sure the development server is running with: npm run dev`, 'error');
            }
        }
        
        function testHistoricalDataPage() {
            const url = window.location.origin + '/dashboard/historical';
            window.open(url, '_blank');
            
            log(`üöÄ Historical Data Page opened: ${url}

üìã Expected Results:
1. Page should load without flickering
2. Historical Data tab should show collected data
3. Data should be filterable by date range
4. Data should be filterable by keyword
5. Both news and social data should be visible

üîç What to Look For:
- Data appears in the Historical Data section
- Date range filters work
- Keyword filters work
- No "No data found" message (if data was collected)

üí° If you still see "No data found":
1. Make sure you triggered data collection first
2. Check that the server is running
3. Verify the data collection was successful`, 'info');
        }
        
        async function checkDataStorage() {
            try {
                const userData = localStorage.getItem('user');
                if (!userData) {
                    log('‚ùå Please create test user first!', 'error');
                    return;
                }
                
                const user = JSON.parse(userData);
                const token = btoa(JSON.stringify({ userId: user.id }));
                
                log('üîç Checking data storage...\n', 'info');
                
                // Check monitoring data (dashboard)
                const monitoringResponse = await fetch('/api/data/monitoring', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Check historical data
                const historicalResponse = await fetch('/api/historical-data', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let report = 'üìä Data Storage Report:\n\n';
                
                if (monitoringResponse.ok) {
                    const monitoringData = await monitoringResponse.json();
                    report += `‚úÖ Dashboard Data (monitoringData):\n`;
                    report += `   - Keywords: ${monitoringData.monitoringData?.length || 0}\n`;
                    report += `   - News Articles: ${monitoringData.monitoringData?.reduce((sum, item) => sum + (item.newsData?.results?.length || 0), 0) || 0}\n`;
                    report += `   - Social Posts: ${monitoringData.monitoringData?.reduce((sum, item) => sum + (item.socialData?.data?.length || 0), 0) || 0}\n\n`;
                } else {
                    report += `‚ùå Dashboard Data: Failed to fetch\n\n`;
                }
                
                if (historicalResponse.ok) {
                    const historicalData = await historicalResponse.json();
                    report += `‚úÖ Historical Data:\n`;
                    report += `   - News Articles: ${historicalData.data?.news?.length || 0}\n`;
                    report += `   - Social Posts: ${historicalData.data?.social?.length || 0}\n`;
                    report += `   - Total News: ${historicalData.data?.totalNews || 0}\n`;
                    report += `   - Total Social: ${historicalData.data?.totalSocial || 0}\n\n`;
                } else {
                    report += `‚ùå Historical Data: Failed to fetch\n\n`;
                }
                
                report += `üéØ Expected Results:\n`;
                report += `- Both dashboard and historical data should have the same content\n`;
                report += `- Historical data should be accessible via the Historical Data page\n`;
                report += `- Data should be filterable by date and keyword\n\n`;
                report += `üí° If historical data is empty but dashboard data exists, trigger data collection first.`;
                
                log(report, 'info');
                
            } catch (error) {
                log(`‚ùå Error checking data storage: ${error.message}`, 'error');
            }
        }
        
        // Auto-create test user on page load
        window.addEventListener('load', () => {
            setTimeout(createTestUser, 500);
        });
    </script>
</body>
</html>
